<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Aroma Mock by haarcuba</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Aroma Mock</h1>
      <h2 class="project-tagline">JavaScript automatic Mock objects with Scenarios: test *exactly* what you want</h2>
      <a href="https://github.com/haarcuba/aroma-mock" class="btn">View on GitHub</a>
      <a href="https://github.com/haarcuba/aroma-mock/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/haarcuba/aroma-mock/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="aromamock---mocking-framework-for-javascript-and-coffeescript" class="anchor" href="#aromamock---mocking-framework-for-javascript-and-coffeescript" aria-hidden="true"><span class="octicon octicon-link"></span></a>AromaMock - Mocking Framework for JavaScript and CoffeeScript</h1>

<p>Aroma is a CoffeeScript Mock Framework. This of course means that it <em>can</em> be
used to test and develop JavaScript, but in this document, I will address
CoffeeScript, because I like it better. It provides a useful
scenario-expectations construct and easy, on the fly mock object generation.</p>

<p>The scenario verifies the exact expected function call sequence including the
function arguments. Scenarios are specified before the code is run, making the
tests well organized, readable and more explicit. </p>

<p>The scenario abstraction verifies that things happen <em>exactly</em> as specified:
i.e. we do not only verify that some mock function was called with specific
paramenter, we verify that it has <em>not</em> been called more times that it should
have been, with some other parameters.</p>

<p>Original concepts were carried over from <a href="http://github.com/shlomimatichin/Voodoo-Mock">Voodoo-Mock</a>, a C++/Python unit test
framework.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>$ npm install aroma-mock
</code></pre>

<p>You will also probably want to</p>

<pre><code>$ npm install mocha coffee-script
</code></pre>

<h2>
<a id="running-coffeescript-tests-with-mocha" class="anchor" href="#running-coffeescript-tests-with-mocha" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running CoffeeScript Tests with Mocha</h2>

<p>In the following examples I use <a href="http://mochajs.org">Mocha</a> for a test runner.
In order for Mocha to work with CoffeeScript you must use it like this:</p>

<pre><code>$ mocha --compilers coffee:coffee-script/register [tests...]
</code></pre>

<h2>
<a id="using-aroma-mock-with-javascript" class="anchor" href="#using-aroma-mock-with-javascript" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Aroma-Mock with JavaScript</h2>

<p>Aroma-Mock is written in CoffeeScript. It can be used in JavaScript by requiring the <code>coffee-script/register</code> in your test code, and then requiring <code>aroma-mock</code>:</p>

<h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h2>

<p>Here's an example test, that mocks the jQuery $ symbol and tests that it is
used as expected.  Before reading the entire thing, let's just look at the <code>call</code> expectation: </p>

<pre><code>call( '$', [ "#input_element" ], fakeObject( 'element', ['val'] ) )
</code></pre>

<p>expresses our expectation that the tested code will call <code>$</code> with
<code>"#input_element"</code> as its first argument. We also arrange that the return value
of this call will be a Mock Object called <code>element</code>.  </p>

<p>We <em>then</em> expect that this <code>element</code> object's <code>val</code> method will be called with
one argument, the string <code>'123'</code>. This is expressed in the expectation:</p>

<pre><code>call( 'element.val', [ '123' ] )
</code></pre>

<p>Since we don't care about the return value from this call, we leave it unspecified. We can also use <code>null</code></p>

<pre><code>call( 'element.val', [ '123' ], null )
</code></pre>

<p>Since jQuery expectations are commonplace, we can use the shorthand
<code>expect_$</code> for this 2-call expectation - this is demonstrated below.</p>

<p>Another thing to note is the use of <code>capture</code> and <code>captured</code> to test functions
called with callbacks. E.g., if our code calls <code>fs.mkdir( 'somepath', onCreated
)</code>, we want to later call this <code>onCreated</code> function. We therefore use the
<code>capture</code> feature of Aroma-Mock to get at it:</p>

<pre><code>call( 'fs.mkdir', [ 'somepath', capture( 'onCreatedCallback' ) ] )
</code></pre>

<p>and later call it via the <code>captured</code> API:</p>

<pre><code>captured.onCreatedCallback()
</code></pre>

<p>I hope this makes the following, complete listing, clear.</p>

<div class="highlight highlight-coffeescript"><pre><span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">'</span>aroma-mock<span class="pl-pds">'</span></span> <span class="pl-c"># import the Aroma-Mock framework</span>
<span class="pl-v"><span class="pl-v">example <span class="pl-k">=</span></span></span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">'</span>../example<span class="pl-pds">'</span></span>

fakeGlobal( <span class="pl-s"><span class="pl-pds">'</span>$<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>getJSON<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>ajax<span class="pl-pds">'</span></span> ] )
fakeGlobal( <span class="pl-s"><span class="pl-pds">'</span>Point<span class="pl-pds">'</span></span>, [] )

describe <span class="pl-s"><span class="pl-pds">'</span>example of aroma mocking framework<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
    it <span class="pl-s"><span class="pl-pds">'</span>should get JSON with jQuery<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">tested <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">example.Example</span>()
        <span class="pl-v"><span class="pl-v">scenario <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">Scenario</span>()
        scenario.expect call( <span class="pl-s"><span class="pl-pds">'</span>$.getJSON<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>www.google.com<span class="pl-pds">'</span></span>, {<span class="pl-v"><span class="pl-v">a:</span></span><span class="pl-c1">1</span>, <span class="pl-v"><span class="pl-v">b:</span></span><span class="pl-c1">2</span>}, capture( <span class="pl-s"><span class="pl-pds">'</span>doneCallback<span class="pl-pds">'</span></span> ) ], <span class="pl-c1">null</span> )

        tested.getSomeJSON()
        scenario.end()

        captured.doneCallback()

    it <span class="pl-s"><span class="pl-pds">'</span>should use jQuery on the DOM<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">tested <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">example.Example</span>()
        <span class="pl-v"><span class="pl-v">scenario <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">Scenario</span>()
        scenario.expect call( <span class="pl-s"><span class="pl-pds">'</span>$<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">"</span>#input_element<span class="pl-pds">"</span></span> ], fakeObject( <span class="pl-s"><span class="pl-pds">'</span>element<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>val<span class="pl-pds">'</span></span>] ) )
        scenario.expect call( <span class="pl-s"><span class="pl-pds">'</span>element.val<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>123<span class="pl-pds">'</span></span> ], <span class="pl-c1">null</span> )
        tested.useJQueryOnDOM( <span class="pl-s"><span class="pl-pds">'</span>123<span class="pl-pds">'</span></span> )
        scenario.end()

    it <span class="pl-s"><span class="pl-pds">'</span>should use jQuery on the DOM: example of expect_$ shorthand notation<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">tested <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">example.Example</span>()
        <span class="pl-v"><span class="pl-v">scenario <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">Scenario</span>()
        scenario.expect_$( <span class="pl-s"><span class="pl-pds">'</span>#input_element<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>val<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>456<span class="pl-pds">'</span></span> ], <span class="pl-c1">null</span> )
        tested.useJQueryOnDOM( <span class="pl-s"><span class="pl-pds">'</span>456<span class="pl-pds">'</span></span> )
        scenario.end()</pre></div>

<p>here's the code that passes this test:</p>

<div class="highlight highlight-coffeescript"><pre><span class="pl-k">class</span> <span class="pl-en">Example</span>
    <span class="pl-en">useJQueryOnDOM</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">( text )</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        $(<span class="pl-s"><span class="pl-pds">"</span>#input_element<span class="pl-pds">"</span></span>).val( text )

    <span class="pl-en">getSomeJSON</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        $.getJSON <span class="pl-s"><span class="pl-pds">'</span>www.google.com<span class="pl-pds">'</span></span>, {<span class="pl-v"><span class="pl-v">a:</span></span><span class="pl-c1">1</span>,<span class="pl-v"><span class="pl-v">b:</span></span><span class="pl-c1">2</span>}, <span class="pl-v">this</span>._mycallback

    <span class="pl-en">_mycallback</span><span class="pl-k">:</span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>( <span class="pl-s"><span class="pl-pds">'</span>my callback called!<span class="pl-pds">'</span></span> )

<span class="pl-v"><span class="pl-v">exports.Example <span class="pl-k">=</span></span></span> Example</pre></div>

<h2>
<a id="asynchronous-ajax-json-retrieval-example" class="anchor" href="#asynchronous-ajax-json-retrieval-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Asynchronous Ajax JSON Retrieval Example</h2>

<p>The <code>AjaxTest</code> class allows testing for an asynchronous ajax call. We define
the parameters of the ajax call, the data supposedly returned from the server,
and what we expect should happen on success.</p>

<p>Here's an asynchronous ajax test:</p>

<div class="highlight highlight-coffeescript"><pre>
<span class="pl-c"># we don't use getJSON in this example, but this is how to create a fake object</span>
<span class="pl-c"># with multiple methods.</span>
fakeGlobal( <span class="pl-s"><span class="pl-pds">'</span>$<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>getJSON<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>ajax<span class="pl-pds">'</span></span> ] )

describe <span class="pl-s"><span class="pl-pds">'</span>example of aroma ajax mocking<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
    it <span class="pl-s"><span class="pl-pds">'</span>aroma can test asynchronous AJAX<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">tested <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">example.Example</span>()
        <span class="pl-v"><span class="pl-v">scenario <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">Scenario</span>()
        <span class="pl-v"><span class="pl-v">ajaxTest <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">AjaxTest</span>( scenario )
        ajaxTest.expect( { <span class="pl-v"><span class="pl-v">url:</span></span> <span class="pl-s"><span class="pl-pds">'</span>/path/to/return_keys.json<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-v">data:</span></span> { <span class="pl-v"><span class="pl-v">a:</span></span> <span class="pl-c1">1</span>, <span class="pl-v"><span class="pl-v">b:</span></span> <span class="pl-c1">2</span> }, <span class="pl-v"><span class="pl-v">type:</span></span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span> } )
        ajaxTest.returnFromServer( { <span class="pl-v"><span class="pl-v">status:</span></span> <span class="pl-s"><span class="pl-pds">'</span>ok<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-v">answer:</span></span> [ <span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span> ] } )
        <span class="pl-en">ajaxTest.onSuccessScenario </span><span class="pl-k">=</span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
            scenario.expect_$( <span class="pl-s"><span class="pl-pds">"</span>#status<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>val<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>ok<span class="pl-pds">'</span></span> ], <span class="pl-c1">null</span> )
            scenario.expect_$( <span class="pl-s"><span class="pl-pds">"</span>#output_element<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>val<span class="pl-pds">'</span></span>, [ [ <span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span> ] ], <span class="pl-c1">null</span> )

        tested.doAsyncAjax( { <span class="pl-v"><span class="pl-v">a:</span></span> <span class="pl-c1">1</span>, <span class="pl-v"><span class="pl-v">b:</span></span> <span class="pl-c1">2</span> } )
        ajaxTest.verify()
        scenario.end()</pre></div>

<p>this is the code that passes it</p>

<div class="highlight highlight-coffeescript"><pre><span class="pl-k">class</span> <span class="pl-en">Example</span>
    <span class="pl-en">doAsyncAjax</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">( data )</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        <span class="pl-en">success </span><span class="pl-k">=</span><span class="pl-smi"> <span class="pl-smi">(data)</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
            $(<span class="pl-s"><span class="pl-pds">"</span>#status<span class="pl-pds">"</span></span>).val( data.status )
            $(<span class="pl-s"><span class="pl-pds">"</span>#output_element<span class="pl-pds">"</span></span>).val( data.answer )
        $.ajax { <span class="pl-v"><span class="pl-v">url:</span></span> <span class="pl-s"><span class="pl-pds">'</span>/path/to/return_keys.json<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-v">data:</span></span> data, <span class="pl-v"><span class="pl-v">type:</span></span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-v">success:</span></span> success }</pre></div>

<p>a test that checks the response to an error can also be written</p>

<div class="highlight highlight-coffeescript"><pre>
<span class="pl-c"># we don't use getJSON in this example, but this is how to create a fake object</span>
<span class="pl-c"># with multiple methods.</span>
fakeGlobal( <span class="pl-s"><span class="pl-pds">'</span>$<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>getJSON<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>ajax<span class="pl-pds">'</span></span> ] )

describe <span class="pl-s"><span class="pl-pds">'</span>example of aroma ajax mocking<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
    it <span class="pl-s"><span class="pl-pds">'</span>aroma asynchronous AJAX error example<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">tested <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">example.Example</span>()
        <span class="pl-v"><span class="pl-v">scenario <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">Scenario</span>()
        <span class="pl-v"><span class="pl-v">ajaxTest <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">AjaxTest</span>( scenario )
        ajaxTest.expect( { <span class="pl-v"><span class="pl-v">url:</span></span> <span class="pl-s"><span class="pl-pds">'</span>/path/to/return_keys.json<span class="pl-pds">'</span></span>, <span class="pl-v"><span class="pl-v">data:</span></span> { <span class="pl-v"><span class="pl-v">a:</span></span> <span class="pl-c1">1</span>, <span class="pl-v"><span class="pl-v">b:</span></span> <span class="pl-c1">2</span> }, <span class="pl-v"><span class="pl-v">type:</span></span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span> } )
        ajaxTest.errorFromServer( <span class="pl-c1">null</span>, <span class="pl-s"><span class="pl-pds">'</span>error text 123<span class="pl-pds">'</span></span>, <span class="pl-c1">null</span> )
        <span class="pl-en">ajaxTest.onErrorScenario </span><span class="pl-k">=</span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
            scenario.expect_$( <span class="pl-s"><span class="pl-pds">"</span>#status<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>val<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>error text 123<span class="pl-pds">'</span></span> ], <span class="pl-c1">null</span> )
            scenario.expect_$( <span class="pl-s"><span class="pl-pds">"</span>#output_element<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">'</span>val<span class="pl-pds">'</span></span>, [ [] ], <span class="pl-c1">null</span> )

        tested.doAsyncAjax( { <span class="pl-v"><span class="pl-v">a:</span></span> <span class="pl-c1">1</span>, <span class="pl-v"><span class="pl-v">b:</span></span> <span class="pl-c1">2</span> } )
        ajaxTest.verify( <span class="pl-s"><span class="pl-pds">'</span>error<span class="pl-pds">'</span></span> )
        scenario.end()</pre></div>

<p>This code passes the test, as well as the previous one:</p>

<div class="highlight highlight-coffeescript"><pre><span class="pl-k">class</span> <span class="pl-en">Example</span>
    <span class="pl-en">doAsyncAjax</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">( data )</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        <span class="pl-en">success </span><span class="pl-k">=</span><span class="pl-smi"> <span class="pl-smi">(data)</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
            $(<span class="pl-s"><span class="pl-pds">"</span>#status<span class="pl-pds">"</span></span>).val( data.status )
            $(<span class="pl-s"><span class="pl-pds">"</span>#output_element<span class="pl-pds">"</span></span>).val( data.answer )
        <span class="pl-en">error </span><span class="pl-k">=</span><span class="pl-smi"> <span class="pl-smi">( unused, text, unused2 )</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
            $(<span class="pl-s"><span class="pl-pds">"</span>#status<span class="pl-pds">"</span></span>).val( text )
            $(<span class="pl-s"><span class="pl-pds">"</span>#output_element<span class="pl-pds">"</span></span>).val( [] )

        $.ajax {    <span class="pl-v"><span class="pl-v">url:</span></span> <span class="pl-s"><span class="pl-pds">'</span>/path/to/return_keys.json<span class="pl-pds">'</span></span>,\
                    <span class="pl-v"><span class="pl-v">data:</span></span> data,
                    <span class="pl-v"><span class="pl-v">type:</span></span> <span class="pl-s"><span class="pl-pds">'</span>POST<span class="pl-pds">'</span></span>,
                    <span class="pl-v"><span class="pl-v">success:</span></span> success,
                    <span class="pl-v"><span class="pl-v">error:</span></span> error }</pre></div>

<h2>
<a id="the-callback-cascade-pattern" class="anchor" href="#the-callback-cascade-pattern" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Callback Cascade Pattern</h2>

<p>When writing JavaScript code, it often happens that we get a cascade of
callback functions, since almost everything is done asynchronously.  For
example, say we want to check if some directory exists, and if not, create it,
and then run some subprocess in the directory. If the directory already exists,
we don't need to create it.</p>

<p>The callback cascade here is</p>

<pre><code>fs.exists =&gt; fs.mkdir =&gt; childProcess.exec
</code></pre>

<p>We can use <code>capture</code> for this, but it gets ugly really fast. If the callback
argument for each function in our cascade is the <em>last</em> one, which is often the
case, e.g.</p>

<pre><code>fs.exists(path, callback)
</code></pre>

<p>We can use the <em>cascade</em> pattern:</p>

<div class="highlight highlight-coffeescript"><pre><span class="pl-v"><span class="pl-v">rewire <span class="pl-k">=</span></span></span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">'</span>rewire<span class="pl-pds">'</span></span>

describe <span class="pl-s"><span class="pl-pds">'</span>cascade of callbacks<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
    beforeEach <span class="pl-k">-&gt;</span>
        cascadeModule.__set__( <span class="pl-s"><span class="pl-pds">'</span>fs<span class="pl-pds">'</span></span>, fakeObject( <span class="pl-s"><span class="pl-pds">'</span>fs<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>exists<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>mkdir<span class="pl-pds">'</span></span> ] ) )
        cascadeModule.__set__( <span class="pl-s"><span class="pl-pds">'</span>childProcess<span class="pl-pds">'</span></span>, fakeObject( <span class="pl-s"><span class="pl-pds">'</span>childProcess<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>exec<span class="pl-pds">'</span></span> ] ) )

    it <span class="pl-s"><span class="pl-pds">'</span>should work<span class="pl-pds">'</span></span>, <span class="pl-k">-&gt;</span>
        <span class="pl-v"><span class="pl-v">myCallback <span class="pl-k">=</span></span></span> fakeObject( <span class="pl-s"><span class="pl-pds">'</span>myCallback<span class="pl-pds">'</span></span> )
        scenario.expectCascade [    cascade( <span class="pl-s"><span class="pl-pds">'</span>fs.exists<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>some_path<span class="pl-pds">'</span></span> ], <span class="pl-c1">null</span>, [<span class="pl-c1">false</span>] ),
                                    cascade( <span class="pl-s"><span class="pl-pds">'</span>fs.mkdir<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>some_path<span class="pl-pds">'</span></span> ] ),
                                    cascade( <span class="pl-s"><span class="pl-pds">'</span>childProcess.exec<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">'</span>some command<span class="pl-pds">'</span></span>, {<span class="pl-v"><span class="pl-v">cwd:</span></span> <span class="pl-s"><span class="pl-pds">'</span>some_path<span class="pl-pds">'</span></span>} ], <span class="pl-c1">null</span>, [ <span class="pl-c1">null</span>, <span class="pl-s"><span class="pl-pds">"</span>output string<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>error string<span class="pl-pds">"</span></span> ] ),
                                    call( <span class="pl-s"><span class="pl-pds">'</span>myCallback<span class="pl-pds">'</span></span>, [ <span class="pl-s"><span class="pl-pds">"</span>output string<span class="pl-pds">"</span></span> ] ) ]

        <span class="pl-v"><span class="pl-v">tested <span class="pl-k">=</span></span></span> <span class="pl-k">new</span> <span class="pl-en">cascadeModule.Cascade</span>()

        tested.go( <span class="pl-s"><span class="pl-pds">'</span>some_path<span class="pl-pds">'</span></span>, myCallback )
        scenario.end()
</pre></div>

<p>NOTE the use of <a href="https://github.com/jhnns/rewire"><em>rewire</em></a> to mock objects inside the module.</p>

<p>This expresses the expectation that the code will call <code>fs.exists</code> - passing it
<code>some_path</code>. The <code>fs.exists</code> cascade specifies that <code>fs.exists</code> will return
<code>null</code>, <em>and then</em> call its callback with the arguments specified in a list, in
this case <code>[false]</code>, so just one argument.</p>

<p>What happens when <code>fs.exists</code>'s callback is called? Since the directory does
not exist (we made <code>fs.exists</code> pass <code>false</code> to its callback, remember?) we
expect it to call <code>fs.mkdir</code>, which will the call <em>its</em> callback.</p>

<p>We then demand that this callback call <code>childProcess.exec</code> and we specify the
output and error strings passed to <em>its</em> callback, which should, finally, call
the user's callback.</p>

<p>NOTE the last call in the cascade is a <code>call</code>, not a <code>cascade</code> - since we don't
want it to automatically call a callback.</p>

<p>The code that passes this test would be:</p>

<div class="highlight highlight-coffeescript"><pre><span class="pl-v"><span class="pl-v">fs <span class="pl-k">=</span></span></span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">'</span>fs<span class="pl-pds">'</span></span>
<span class="pl-v"><span class="pl-v">childProcess <span class="pl-k">=</span></span></span> <span class="pl-c1">require</span> <span class="pl-s"><span class="pl-pds">'</span>child_process<span class="pl-pds">'</span></span>

<span class="pl-k">class</span> <span class="pl-en">Cascade</span>
    <span class="pl-en">go</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">( path, callback )</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        <span class="pl-smi">@callback</span> <span class="pl-k">=</span> callback
        fs.exists path, <span class="pl-smi">(exists)</span> <span class="pl-k">=&gt;</span>
            <span class="pl-k">if</span> exists
                <span class="pl-v">this</span>._runChild( path )
            <span class="pl-k">else</span>
                fs.mkdir path, <span class="pl-k">=&gt;</span>
                    <span class="pl-v">this</span>._runChild( path )

    <span class="pl-en">_runChild</span><span class="pl-k">:</span><span class="pl-smi"> <span class="pl-smi">( path )</span></span> <span class="pl-k"><span class="pl-k">=&gt;</span></span>
        childProcess.exec <span class="pl-s"><span class="pl-pds">'</span>some command<span class="pl-pds">'</span></span>, { <span class="pl-v"><span class="pl-v">cwd:</span></span> path }, <span class="pl-smi">(err, output, error)</span> <span class="pl-k">=&gt;</span>
            <span class="pl-smi">@callback</span>( output )

<span class="pl-v"><span class="pl-v">exports.Cascade <span class="pl-k">=</span></span></span> Cascade</pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/haarcuba/aroma-mock">Aroma Mock</a> is maintained by <a href="https://github.com/haarcuba">haarcuba</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-59792836-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

